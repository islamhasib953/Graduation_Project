السايكل المعدلة
استقبال البيانات:
الساعة بترسل بيانات عبر MQTT → تتخزن في SensorData (بدون إرسال للفرونت).
التحقق الدوري:
كل 30 ثانية، النظام بيجيب آخر 10 قراءات من SensorData لكل طفل، يعمل التحقق، يخزن النتيجة في ValidatedSensorData، وبيبعتها فورًا للفرونت عبر WebSocket.
العرض في الفرونت:
الفرونت بيستقبل البيانات الموثقة فقط، وبيعرض أحدث ريكورد بمجرد ما يتضاف في ValidatedSensorData.
التحديث والوقت
التحديث: البيانات الموثقة بتظهر في الفرونت كل 30 ثانية (لأن التحقق بيحصل كل 30 ثانية).
الوقت: زي ما شرحت قبل كده، السايكل بتاخد حوالي 0.7 ثانية لـ 100 طفل، يعني الإرسال للفرونت بيحصل فوريًا بعد التحقق.

****************************************************
السايكل (دورة العمل) شغالة إزاي؟
السايكل هي العملية الكاملة اللي بتحصل من أول ما البيانات تيجي من الساعة لحد ما تتعرض في الفرونت. النظام بيتعامل مع البيانات على مراحل، وكل مرحلة ليها دور معين. هنا الخطوات بالتفصيل:

استقبال البيانات من الساعة عبر MQTT:
الساعة اللي بيلبسها الطفل بترسل بيانات (زي bpm, spo2, temperature) عبر بروتوكول MQTT.
الـ MQTTService.js بيستقبل البيانات دي عن طريق الاشتراك في موضوع معين (topic) محدد في إعدادات MQTT.
لما بيانات جديدة تيجي، الـ MQTT Service بيحفظها فورًا في قاعدة البيانات في جدول SensorData (اللي هو المكان بتاع البيانات الخام).
في نفس الوقت، الـ MQTT Service بيبعت البيانات الخام دي للفرونت عبر WebSocket (باستخدام Socket.IO) عشان الفرونت يشوف البيانات الخام على طول.
التحقق الدوري (كل 30 ثانية):
في الخلفية، النظام بيشتغل على دورة تحقق تلقائية كل 30 ثانية (زي ساعة بتشتغل باستمرار).
الدورة دي معمولة في sensorData.controller.js داخل دالة startContinuousValidation، وبيتم استدعاؤها في app.js لما السيرفر يشتغل.
في كل دورة (كل 30 ثانية):
النظام بيجيب كل الأطفال المسجلين في قاعدة البيانات (من جدول Child).
لكل طفل، بيجيب آخر 10 قراءات من SensorData (البيانات الخام).
بيعمل التحقق على القراءات دي بناءً على عمر الطفل:
bpm: يتحقق إن معدل القلب في النطاق الطبيعي (مثلاً 60-95 لو الطفل 6 سنين).
spo2: يتحقق إن الأكسجين بين 90% و100%.
ir: يتحقق إن معدل التنفس في النطاق (مثلاً 14-22 لو الطفل 6 سنين).
temperature: يتحقق إن الحرارة بين 36.1 و37.2 درجة مئوية.
السينسورات زي accX, gyroX, إلخ، مش بيتحقق منها، بس بياخد متوسطها.
بيحسب متوسط القراءات الصحيحة لكل سينسور، ويحدد حالة التحقق (Validated, PartiallyValidated, Invalid).
بيخزن الريكورد الموثق في جدول ValidatedSensorData.
بيبعت الريكورد الموثق ده للفرونت عبر WebSocket (باستخدام Socket.IO) عشان الفرونت يعرضه.
عرض البيانات في الفرونت:
الفرونت (الصفحة الـ HTML) متصل مع السيرفر عبر WebSocket (Socket.IO).
لما الفرونت يستقبل بيانات (سواء البيانات الخام من MQTT أو البيانات الموثقة من التحقق الدوري)، بيعرضها على الشاشة.
البيانات الموثقة بتظهر كل 30 ثانية (لأن التحقق الدوري بيحصل كل 30 ثانية)، والبيانات الخام بتظهر فورًا لما تيجي من الساعة.
السايكل بتتحدث على قد إيه؟
البيانات الخام:
البيانات الخام (اللي جاية من الساعة عبر MQTT) بتتحدث فورًا لما الساعة ترسل بيانات جديدة. يعني لو الساعة بترسل كل 10 ثواني مثلاً، الفرونت هيشوف التحديث كل 10 ثواني.
ده بيعتمد على سرعة إرسال الساعة، مش على النظام بتاعنا. النظام بيستقبل البيانات ويبعتها للفرونت على طول من غير تأخير.
البيانات الموثقة:
البيانات الموثقة (اللي في ValidatedSensorData) بتتحدث كل 30 ثانية، لأن التحقق الدوري معمول بـ setInterval كل 30 ثانية.
يعني كل 30 ثانية، النظام بياخد آخر 10 قراءات من SensorData، يعمل التحقق، ويخزن النتيجة في ValidatedSensorData، وبيبعتها للفرونت.
الفرونت:
الفرونت بيستقبل تحديثات على مرحلتين:
البيانات الخام: بتيجي فورًا لما الساعة ترسل (حسب سرعة الساعة).
البيانات الموثقة: بتيجي كل 30 ثانية بعد التحقق.
السايكل بتاخد وقت قد إيه؟
السايكل نفسها (يعني عملية التحقق الدوري) بتتكون من خطوات، ومدة تنفيذها بتعتمد على كام عامل. هحسب الوقت تقريبيًا بناءً على الكود:

جلب الأطفال من قاعدة البيانات:
النظام بيجيب كل الأطفال من جدول Child باستخدام Child.find().
الوقت ده بيعتمد على عدد الأطفال في قاعدة البيانات:
لو عندك 100 طفل مثلاً، وكل استعلام بياخد حوالي 1 ميلي ثانية (ده افتراضي لو قاعدة البيانات سريعة)، يبقى الخطوة دي بتاخد حوالي 100 ميلي ثانية (0.1 ثانية).
جلب آخر 10 قراءات لكل طفل:
لكل طفل، النظام بيجيب آخر 10 قراءات من SensorData باستخدام SensorData.find().sort().limit(10).
لو كل استعلام بياخد حوالي 2 ميلي ثانية (افتراضي)، وعدد الأطفال 100، يبقى الوقت = 100 طفل × 2 ميلي ثانية = 200 ميلي ثانية (0.2 ثانية).
التحقق وحساب المتوسطات:
لكل طفل، النظام بيفحص القراءات (bpm, spo2, ir, temperature) ويحسب المتوسطات.
الفحص نفسه عملية برمجية بسيطة (مقارنات وجمع وقسمة)، وده بياخد وقت صغير جدًا، يعني حوالي 1 ميلي ثانية لكل طفل.
لو 100 طفل، يبقى الوقت = 100 × 1 ميلي ثانية = 100 ميلي ثانية (0.1 ثانية).
تخزين البيانات الموثقة:
النظام بيخزن الريكورد الموثق في ValidatedSensorData باستخدام save().
لو كل عملية حفظ بتاخد 2 ميلي ثانية، يبقى لـ 100 طفل، الوقت = 100 × 2 ميلي ثانية = 200 ميلي ثانية (0.2 ثانية).
إرسال البيانات عبر WebSocket:
النظام بيبعت البيانات الموثقة للفرونت عبر Socket.IO.
الإرسال نفسه سريع جدًا، حوالي 1 ميلي ثانية لكل طفل.
لو 100 طفل، يبقى الوقت = 100 × 1 ميلي ثانية = 100 ميلي ثانية (0.1 ثانية).
إجمالي الوقت للسايكل:
لو نجمع الخطوات دي:
جلب الأطفال: 0.1 ثانية
جلب القراءات: 0.2 ثانية
التحقق والمتوسطات: 0.1 ثانية
التخزين: 0.2 ثانية
الإرسال: 0.1 ثانية
الإجمالي = 0.1 + 0.2 + 0.1 + 0.2 + 0.1 = 0.7 ثانية (700 ميلي ثانية) تقريبًا لـ 100 طفل.
ملاحظات على الوقت:
الوقت ده افتراضي بناءً على أداء قاعدة بيانات وشبكة مثالية. لو قاعدة البيانات بطيئة أو الشبكة فيها تأخير، الوقت ممكن يزيد (يمكن يوصل لـ 1-2 ثانية).
لو عدد الأطفال أقل (مثلاً 10 أطفال)، الوقت هيبقى أقل بكتير، حوالي 70 ميلي ثانية (0.07 ثانية).
التحقق نفسه بيحصل كل 30 ثانية، يعني السايكل دي بتاخد أقل من 1% من الوقت بين كل تحديث، فالنظام شغال بكفاءة عالية.
ملخص
إزاي السايكل شغالة؟
الساعة بترسل بيانات عبر MQTT → تتخزن في SensorData → تتبعت للفرونت فورًا.
كل 30 ثانية، النظام بيجيب آخر 10 قراءات لكل طفل، يتحقق منها، يخزن النتيجة في ValidatedSensorData، ويبعتها للفرونت.
الفرونت بيعرض البيانات الخام فورًا والبيانات الموثقة كل 30 ثانية.
بتتحدث على قد إيه؟
البيانات الخام: فورًا لما الساعة ترسل (حسب سرعة الساعة).
البيانات الموثقة: كل 30 ثانية.
السايكل بتاخد وقت قد إيه؟
تقريبًا 0.7 ثانية لـ 100 طفل، وأقل لو عدد الأطفال أقل.
************************************************************
لوجيك
********************
تمام، هشرح اللوجيك بالكلام بطريقة بسيطة وواضحة من غير كود، عشان تفهم بالضبط إيه اللي عملته خطوة بخطوة بناءً على طلباتك. هحطط الأمور بالترتيب حسب التغييرات اللي طلبتهم، وهذكر إزاي اللوجيك بيعتمد على عمر الطفل (من 6 أشهر لـ 7 سنين) وعلى البيانات اللي جاية من الساعة.

الفكرة العامة
أنا خلقت نظام جديد بياخد البيانات اللي بتيجي من الساعة اللي بيلبسها الطفل، ويتاكد إنها صحيحة قبل ما تعرض على الفرونت. اللي بيحصل هو إن النظام بيجيب آخر 10 قراءات من الساعة، يفحصها بناءً على عمر الطفل، ويختار أو يحسب أفضل قيمة لكل سينسور (زي معدل القلب، الأكسجين، التنفس، والحرارة). لو القراءة صحيحة، يحطها في مكان جديد (زي خزنة بيانات موثقة)، ولو فيه مشكلة، يعمل عليها تعديل أو يحط علامة إنها مش صحيحة. بعدها، الفرونت بياخد البيانات دي من الخزنة الموثقة بدل البيانات الخام.

الخطوات بالتفصيل
1. إنشاء مكان جديد للبيانات الموثقة
عملت مكان تخزين جديد اسمه "البيانات الموثقة" (زي جدول منفصل في قاعدة البيانات) عشان يحتفظ بالقراءات الصحيحة بعد التحقق. ده المكان اللي هيجيب منه الفرونت البيانات لما يطلبها.
المكان ده شبه المكان القديم (اللي بيخزن كل البيانات اللي جاية من الساعة)، لكنه فيه حقل إضافي يسمى "حالة التحقق" (زي علامة تقول إذا كانت البيانات صحيحة كلها، جزء منها صحيح، أو مش صحيحة خالص).
2. حساب عمر الطفل
عشان نعرف القراءات الصحيحة، لازم نعرف عمر الطفل. فحسابنا العمر بطريقة بسيطة: نأخد تاريخ الميلاد من بيانات الطفل، نطرح منه اليوم الحالي، ونجيب عدد السنين. لو الطفل أقل من 6 أشهر أو أكتر من 7 سنين، النظام بيوقف ويقول إن العمر مش مناسب.
3. جمع آخر 10 قراءات من الساعة
النظام بيروح للمكان القديم (اللي بيخزن كل البيانات اللي جاية من الساعة) ويجيب آخر 10 قراءات للطفل بناءً على الوقت اللي اتعملت فيه (من الأحدث للأقدم).
لو مفيش 10 قراءات، بيشتغل على اللي موجود.
4. التحقق من القراءات بناءً على العمر
لكل سينسور، النظام بيفحص القراءات اللي جاية من الساعة ويقارنها بالقيم الطبيعية اللي تناسب عمر الطفل. اللي بيفحصه هو:
معدل ضربات القلب (bpm):
من 6 أشهر لأقل من سنة: بين 90 و120 نبضة في الدقيقة.
من سنة لأقل من 3 سنين: بين 70 و110.
من 3 سنين لأقل من 5 سنين: بين 65 و100.
من 5 سنين لـ 7 سنين: بين 60 و95.
الأكسجين في الدم (spo2):
بين 90% و100%، لو أقل من 90% يعتبر مش صحيح.
معدل التنفس (ir):
من 6 أشهر لأقل من سنة: بين 30 و45 نفسة في الدقيقة.
من سنة لأقل من 3 سنين: بين 20 و30.
من 3 سنين لأقل من 5 سنين: بين 20 و25.
من 5 سنين لـ 7 سنين: بين 14 و22.
درجة الحرارة (temperature):
بين 36.1 درجة مئوية و37.2 درجة مئوية (النطاق الطبيعي لجسم الإنسان، خاصة الأطفال).
السينسورات الأخرى (accX, accY, accZ, status, gyroX, gyroY, gyroZ, latitude, longitude):
مش بيتم فحصها خالص، يعني ما بنقارنش قيمها بشيء، وبس ناخد متوسطها من القراءات كلها.
5. اختيار أو حساب أفضل قيمة لكل سينسور
لكل سينسور اللي فيه تحقق (bpm, spo2, ir, temperature):
النظام بياخد القراءات اللي اتأكدت إنها صحيحة (زي لو bpm كان بين 60 و95 لو الطفل 6 سنين).
لو فيه قراءات صحيحة، بيحسب متوسطها (يعني يجمع القيم الصحيحة ويقسمها على عددها).
لو مفيش قراءات صحيحة خالص (كلهم خارج النطاق)، بيحط 0.
للسينسورات اللي مش فيه تحقق (accX, accY, accZ, إلخ):
بياخد متوسط كل القراءات من غير ما يفحصها، سواء كانت صحيحة أو لأ.
6. تحديد حالة التحقق
بعد ما يفرغ من فحص كل السينسورات:
لو كل القراءات صحيحة، يحط علامة "موثق" (Validated).
لو فيه قراءات صحيحة وغير صحيحة، يحط علامة "موثق جزئيًا" (PartiallyValidated).
لو مفيش قراءات صحيحة خالص، يحط علامة "غير موثق" (Invalid).
7. تخزين البيانات الموثقة
بعد ما يحسب المتوسطات أو يختار القيم، النظام بيحط الريكورد النهائي (زي قيمة bpm, spo2, إلخ مع حالة التحقق) في المكان الجديد "البيانات الموثقة".
الريكورد ده بياخد أيضًا الوقت والحالة (status) من أحدث قراءة في الـ 10.
8. عرض البيانات على الفرونت
الآن، لما الفرونت يطلب البيانات (زي عندما يضغط على زر "عرض القراءات" للطفل)، النظام بيجيب البيانات من المكان الجديد "البيانات الموثقة" بدل المكان القديم اللي فيه البيانات الخام.
يعني لو الفرونت يطلب كل البيانات أو قراءة معينة، هيجيب القيم الموثقة اللي تم حسابها بناءً على التحقق.
9. كيف يشتغل النظام مع الطفل
لو الطفل عمره سنتين، النظام بيفحص bpm بين 70 و110، spo2 بين 90 و100، ir بين 20 و30، وtemperature بين 36.1 و37.2.
لو فيه قراءة bpm 130 (خارج النطاق)، يهملها ويحسب المتوسط من القراءات الصحيحة بس.
لو كل القراءات لـ bpm غلط (مثلاً كلهم 150)، بيحط 0 وبيحط علامة "غير موثق" لو كل حاجة غلط.
النتيجة النهائية
دلوقتي، لما الساعة ترسل بيانات، النظام بيجمع آخر 10 قراءات، يفحصها حسب عمر الطفل، ويحط النتيجة الموثقة في مكان جديد.
الفرونت هيشوف دايمًا البيانات الموثقة، وده بيضمن إن اللي بيطلعه مش فيه أخطاء كبيرة زي معدلات قلب أو تنفس غير طبيعية.
السينسورات زي الحركة (accX, gyroX) أو الموقع (latitude) بتتعامل زي كده من غير فحص، يعني لو فيه قراءات غريبة فيهم، هتدخل في المتوسط ومش هتتجاهل.
لو عايز تفهم حاجة زيادة